@using Connect4.Web.Models
@{
    ViewData["Title"] = "Tablero";
    var tablero = (char[,])ViewBag.Tablero;
    var partida = (Partida)ViewBag.Partida;
    var turnoJugador = partida.TurnoJugador;
    var coordsGanadoras = ViewBag.CoordenadasGanadoras as HashSet<string> ?? new HashSet<string>();
    string simboloTurno = (partida.TurnoJugadorId == partida.Jugador1Id) ? "X" : "O";
}

<h2>Tablero - Partida @partida.PartidaId</h2>

<p>
    <strong style="color: blue;">Jugador 1 (X):</strong> <span style="color: blue;">@partida.Jugador1?.Nombre</span> <br />
    <strong style="color: purple;">Jugador 2 (O):</strong> <span style="color: purple;">@partida.Jugador2?.Nombre</span> <br />

    <strong>Turno actual:</strong>
    @if (partida.TurnoJugadorId == partida.Jugador1Id)
    {
        <span style="color: blue;"><strong>@partida.Jugador1?.Nombre</strong> jugando como <strong>X</strong></span>
    }
    else if (partida.TurnoJugadorId == partida.Jugador2Id)
    {
        <span style="color: purple;"><strong>@partida.Jugador2?.Nombre</strong> jugando como <strong>O</strong></span>
    }
    else
    {
        <span><strong>Desconocido</strong></span>
    }
</p>

<table style="border-collapse: collapse; margin-bottom: 20px;">
    @for (int fila = 5; fila >= 0; fila--)
    {
        <tr>
            @for (int col = 0; col < 7; col++)
            {
                char ficha = tablero[fila, col];
                string clave = $"{fila},{col}";

                string colorTexto = ficha == 'X' ? "blue"
                                  : ficha == 'O' ? "purple"
                                  : "black";

                string fondo = ficha == 'X' || ficha == 'O' ? "#fff8dc" : "white"; // amarillo tenue

                if (coordsGanadoras.Contains(clave))
                {
                    fondo = "lightgreen";
                }

                <td style="width: 40px; height: 40px; text-align: center; border: 1px solid black; font-size: 20px; color:@colorTexto; background-color:@fondo;">
                    @ficha
                </td>
            }
        </tr>
    }

    <tr>
        @for (char letra = 'A'; letra <= 'G'; letra++)
        {
            <td style="text-align: center; font-weight: bold;">@letra</td>
        }
    </tr>
</table>

@if (partida.Estado == "Finalizada")
{
if (partida.Resultado.StartsWith("Victoria"))
{
<p style="color: green; font-weight: bold;">
ğŸ‰ El jugador <strong>@partida.Resultado.Replace("Victoria - ", "")</strong> ha ganado la partida.
</p>
}
else if (partida.Resultado == "Empate")
{
<p style="color: orange; font-weight: bold;">
ğŸ¤ Â¡Empate! El tablero estÃ¡ lleno.
</p>
}
<p>
    <a asp-controller="Partida" asp-action="Index" class="btn btn-secondary">â¬… Volver a la lista de partidas</a>
</p>
}
else
{
<form asp-action="Jugar" method="post">
<input type="hidden" name="id" value="@partida.PartidaId" />
<label>Columna (A-G):</label>
<select name="columna" required>
<option value="">--Seleccionar--</option>
<option value="A">A</option>
<option value="B">B</option>
<option value="C">C</option>
<option value="D">D</option>
<option value="E">E</option>
<option value="F">F</option>
<option value="G">G</option>
</select>
<button type="submit" class="btn btn-success">Jugar</button>
</form>
}
<br>
<form asp-action="Reiniciar" method="post" style="margin-top:20px;">
    <input type="hidden" name="id" value="@partida.PartidaId" />
    <button type="submit" class="btn btn-warning">ğŸ”„ Reiniciar</button>
</form>


@if (TempData["Error"] != null)
{
    <p style="color:red;">@TempData["Error"]</p>
}
